---
import Layout from "../layouts/Layout.astro";
import DashboardNav from "../components/DashboardNav.astro";
import { createClient } from "@supabase/supabase-js";

export const prerender = false;

const SUPABASE_URL = import.meta.env.SUPABASE_URL;
const SUPABASE_SERVICE_ROLE_KEY = import.meta.env.SUPABASE_SERVICE_ROLE_KEY;

const token = Astro.cookies.get("sb-access-token")?.value || "";
if (!token) {
	return Astro.redirect("/login");
}

if (!SUPABASE_SERVICE_ROLE_KEY) {
	throw new Error("SUPABASE_SERVICE_ROLE_KEY manquant");
}

const adminClient = createClient(SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY);
const { data: userData, error: userError } = await adminClient.auth.getUser(token);
const user = userData?.user;
if (userError || !user) {
	return Astro.redirect("/login");
}

const { data: ordersData } = await adminClient
	.from("orders")
	.select("id, order_number, cartons, total, status, estimated_delivery_start, estimated_delivery_end, payment_method, preorder_id, created_at")
	.eq("user_id", user.id)
	.order("created_at", { ascending: false });

const orders = ordersData ?? [];
const orderIds = orders.map((o) => o.id);

const { data: openPreordersData } = await adminClient
	.from("preorders")
	.select("id")
	.eq("status", "open");
const openPreorders = new Set((openPreordersData ?? []).map((p) => p.id));

let flavorCounts: Record<string, number> = {};
if (orderIds.length > 0) {
	const { data: orderFlavorsData } = await adminClient
		.from("order_flavors")
		.select("order_id, quantity")
		.in("order_id", orderIds);
	for (const row of orderFlavorsData ?? []) {
		const key = row.order_id as string;
		const qty = Number(row.quantity || 0);
		flavorCounts[key] = (flavorCounts[key] || 0) + qty;
	}
}

const totalOrders = orders.length;
const totalCartons = orders.reduce((sum, o) => sum + Number(o.cartons || 0), 0);
const totalSpent = orders.reduce((sum, o) => sum + Number(o.total || 0), 0);
const totalSavings = totalCartons * 75;

const formatDate = (value: string | null) => {
	if (!value) return "";
	return new Date(value).toISOString().slice(0, 10);
};

const statusLabel = (status: string | null) => {
	if (status === "delivered") return { text: "Livree", className: "bg-emerald-100 text-emerald-700" };
	if (status === "confirmed") return { text: "Confirmee", className: "bg-blue-100 text-blue-700" };
	return { text: "En cours", className: "bg-amber-100 text-amber-700" };
};
---

<Layout>
	<main class="min-h-screen bg-gradient-to-b from-white via-[#f4f7ff] to-[#f5e7ff] px-4 pb-32 pt-6 sm:px-6 lg:px-8">
		<div class="mx-auto flex max-w-4xl flex-col gap-6">
			<header class="space-y-1">
				<h1 class="text-2xl font-semibold text-slate-900">Mes commandes</h1>
				<p class="text-sm text-slate-600">Suivez l'etat de toutes vos commandes</p>
			</header>

			<section class="grid gap-4 sm:grid-cols-2 lg:grid-cols-4">
				<div class="rounded-2xl bg-white/90 p-4 shadow-lg ring-1 ring-slate-100">
					<p class="text-2xl font-semibold text-slate-900">{totalOrders}</p>
					<p class="text-xs text-slate-500">Commandes totales</p>
				</div>
				<div class="rounded-2xl bg-white/90 p-4 shadow-lg ring-1 ring-slate-100">
					<p class="text-2xl font-semibold text-slate-900">{totalCartons}</p>
					<p class="text-xs text-slate-500">Cartons commandes</p>
				</div>
				<div class="rounded-2xl bg-white/90 p-4 shadow-lg ring-1 ring-slate-100">
					<p class="text-2xl font-semibold text-slate-900">{Math.round(totalSpent)} EUR</p>
					<p class="text-xs text-slate-500">Total depense</p>
				</div>
				<div class="rounded-2xl bg-white/90 p-4 shadow-lg ring-1 ring-slate-100">
					<p class="text-2xl font-semibold text-slate-900">{Math.round(totalSavings)} EUR</p>
					<p class="text-xs text-slate-500">Economies estimees</p>
				</div>
			</section>

			<section class="rounded-2xl bg-white/90 p-4 shadow-lg ring-1 ring-slate-100">
				<p class="text-sm font-semibold text-slate-900">Virement bancaire</p>
				<p class="text-xs text-slate-600">Noah ROGNON</p>
				<p class="text-xs text-slate-600">IBAN: FR76 2823 3000 0114 0003 6014 026</p>
			</section>

			<section class="space-y-4">
				{orders.length === 0 && (
					<div class="rounded-2xl border border-dashed border-slate-200 bg-white/80 p-5 text-center text-slate-600">
						Aucune commande pour le moment.
					</div>
				)}

				{orders.map((order) => {
					const status = statusLabel(order.status);
					const canEdit = openPreorders.has(order.preorder_id);
					const orderFlavors = flavorCounts[order.id] || 0;
					return (
						<article class="rounded-2xl bg-white/90 p-4 shadow-lg ring-1 ring-slate-100">
							<div class="flex items-center justify-between">
								<div>
									<p class="text-sm font-semibold text-slate-900">{order.order_number || "CMD-XXXX"}</p>
									<p class="text-xs text-slate-500">{formatDate(order.created_at)}</p>
								</div>
								<span class={`rounded-full px-3 py-1 text-xs font-semibold ${status.className}`}>
									{status.text}
								</span>
							</div>

							<div class="mt-4 grid grid-cols-3 gap-2 text-center text-sm text-slate-700">
								<div>
									<p class="text-lg font-semibold text-slate-900">{order.cartons}</p>
									<p class="text-xs text-slate-500">Cartons</p>
								</div>
								<div>
									<p class="text-lg font-semibold text-slate-900">{Math.round(Number(order.total || 0))} EUR</p>
									<p class="text-xs text-slate-500">Total</p>
								</div>
								<div>
									<p class="text-lg font-semibold text-slate-900">{orderFlavors}</p>
									<p class="text-xs text-slate-500">Gouts</p>
								</div>
							</div>

							{canEdit && (
								<div class="mt-4 rounded-xl border border-blue-100 bg-blue-50 p-3 text-sm text-slate-700">
									<p class="text-xs font-semibold text-blue-700">Precommande ouverte: modification possible</p>
									<div class="mt-3 flex flex-wrap items-center gap-3" data-order-row data-order-id={order.id}>
										<button type="button" class="flex h-9 w-9 items-center justify-center rounded-full bg-white text-lg font-semibold text-slate-700 shadow-sm" data-carton-dec>-</button>
										<span class="min-w-[2.5rem] text-center text-base font-semibold text-slate-900" data-carton-value>{order.cartons}</span>
										<button type="button" class="flex h-9 w-9 items-center justify-center rounded-full bg-white text-lg font-semibold text-slate-700 shadow-sm" data-carton-inc>+</button>
										<button
											type="button"
											class="rounded-xl bg-gradient-to-r from-[#2d7dff] via-[#7d4bff] to-[#d74bff] px-4 py-2 text-xs font-semibold text-white shadow-sm transition hover:-translate-y-0.5 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-white disabled:opacity-60 disabled:cursor-not-allowed"
											data-carton-save
										>
											Mettre a jour
										</button>
										<button
											type="button"
											class="rounded-xl border border-red-200 bg-white px-4 py-2 text-xs font-semibold text-red-600 shadow-sm transition hover:-translate-y-0.5 hover:shadow-md focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-red-400"
											data-order-delete
										>
											Supprimer
										</button>
										<span class="text-xs text-slate-500" data-carton-total></span>
									</div>
								</div>
							)}
						</article>
					);
				})}
			</section>
		</div>
	</main>
	<DashboardNav />

	<script type="module">
		(() => {
			const rows = document.querySelectorAll("[data-order-row]");
			if (!rows.length) return;

			const pricePerCarton = 75;
			const calcTotal = (cartons) => {
				let discountPct = 0;
				if (cartons >= 10) discountPct = 10;
				else if (cartons >= 5) discountPct = 7;
				else if (cartons >= 3) discountPct = 4;
				return Math.round(cartons * pricePerCarton * (1 - discountPct / 100));
			};

			rows.forEach((row) => {
				const orderId = row.getAttribute("data-order-id");
				const decBtn = row.querySelector("[data-carton-dec]");
				const incBtn = row.querySelector("[data-carton-inc]");
				const saveBtn = row.querySelector("[data-carton-save]");
				const valueEl = row.querySelector("[data-carton-value]");
				const totalEl = row.querySelector("[data-carton-total]");
				if (!orderId || !decBtn || !incBtn || !saveBtn || !valueEl) return;

				let cartons = Number(valueEl.textContent || 0) || 1;
				const updateTotal = () => {
					if (totalEl) totalEl.textContent = `Nouveau total: ${calcTotal(cartons)} EUR`;
				};
				updateTotal();

				decBtn.addEventListener("click", () => {
					cartons = Math.max(1, cartons - 1);
					valueEl.textContent = String(cartons);
					updateTotal();
				});
				incBtn.addEventListener("click", () => {
					cartons += 1;
					valueEl.textContent = String(cartons);
					updateTotal();
				});

				saveBtn.addEventListener("click", async () => {
					saveBtn.disabled = true;
					const originalText = saveBtn.textContent;
					saveBtn.textContent = "Mise a jour...";
					saveBtn.classList.add("opacity-80");
					const response = await fetch("/api/update-order-cartons", {
						method: "POST",
						headers: { "Content-Type": "application/json" },
						body: JSON.stringify({ order_id: orderId, cartons }),
					});
					const result = await response.json().catch(() => null);
					if (!response.ok || !result?.success) {
						alert(result?.error || "Impossible de mettre a jour la commande.");
						saveBtn.disabled = false;
						saveBtn.textContent = originalText || "Mettre a jour";
						saveBtn.classList.remove("opacity-80");
						return;
					}
					saveBtn.disabled = false;
					saveBtn.textContent = "Mis a jour";
					saveBtn.classList.remove("opacity-80");
					setTimeout(() => {
						saveBtn.textContent = originalText || "Mettre a jour";
					}, 1500);
					if (totalEl) totalEl.textContent = `Total mis a jour: ${result.total} EUR`;
				});

				const deleteBtn = row.querySelector("[data-order-delete]");
				if (deleteBtn) {
					deleteBtn.addEventListener("click", async () => {
						const confirmed = window.confirm("Supprimer cette commande ?");
						if (!confirmed) return;
						deleteBtn.disabled = true;
						const originalText = deleteBtn.textContent;
						deleteBtn.textContent = "Suppression...";
						const response = await fetch("/api/delete-order", {
							method: "POST",
							headers: { "Content-Type": "application/json" },
							body: JSON.stringify({ order_id: orderId }),
						});
						const result = await response.json().catch(() => null);
						if (!response.ok || !result?.success) {
							alert(result?.error || "Impossible de supprimer la commande.");
							deleteBtn.disabled = false;
							deleteBtn.textContent = originalText || "Supprimer";
							return;
						}
						row.closest("article")?.remove();
					});
				}
			});
		})();
	</script>
</Layout>
