---
import Layout from "../layouts/Layout.astro";
import { createServerClient } from "../lib/supabaseServer";

export const prerender = false;

let error: string | null = null;

if (Astro.request.method === "POST") {
	const supabase = createServerClient();
	let email = "";
	let password = "";

	try {
		try {
			const formData = await Astro.request.formData();
			email = String(formData.get("email") || "");
			password = String(formData.get("password") || "");
		} catch {
			const body = (await Astro.request.json()) as Record<
				string,
				unknown
			>;
			email = String(body.email || "");
			password = String(body.password || "");
		}

		const { data, error: signInError } = await supabase.auth.signInWithPassword({
			email,
			password,
		});

		if (signInError) {
			error = signInError.message;
		} else {
			if (data?.session) {
				const isSecure = Astro.url.protocol === "https:";
				Astro.cookies.set("sb-access-token", data.session.access_token, {
					path: "/",
					httpOnly: true,
					sameSite: "lax",
					secure: isSecure,
				});
				Astro.cookies.set("sb-refresh-token", data.session.refresh_token, {
					path: "/",
					httpOnly: true,
					sameSite: "lax",
					secure: isSecure,
				});
			}
			return Astro.redirect("/dashboard");
		}
	} catch {
		error = "Le formulaire n'a pas pu être lu. Merci de réessayer.";
	}
}
---

<Layout>
	<main
		class="min-h-screen bg-gradient-to-b from-white via-[#f1f4ff] to-[#f5e7ff] px-4 py-10 sm:px-6 lg:px-8"
	>
		<div class="mx-auto flex max-w-md flex-col gap-6">
			<a
				href="/"
				class="inline-flex items-center gap-2 text-sm text-slate-600 hover:text-slate-800"
			>
				<span class="text-lg">←</span>
				<span>Retour</span>
			</a>

			<section
				class="rounded-[28px] bg-white/80 p-6 shadow-xl ring-1 ring-slate-100 backdrop-blur-md sm:p-8"
			>
				<div class="space-y-1 text-center">
					<p
						class="text-xl font-semibold bg-gradient-to-r from-[#3d7fff] via-[#9d55ff] to-[#d94bff] bg-clip-text text-transparent"
					>
						Les Gens Avant L'Argent
					</p>
					<h1 class="text-2xl font-semibold text-slate-900">
						Connexion
					</h1>
					<p class="text-sm text-slate-600">
						Bon retour sur Les Gens Avant L'Argent !
					</p>
				</div>

				{
					error && (
						<p class="mt-4 rounded-xl bg-red-50 px-4 py-3 text-sm text-red-700">
							{error}
						</p>
					)
				}

				<form method="POST" class="mt-6 space-y-4">
					<label class="block">
						<span class="sr-only">Email</span>
						<div
							class="flex items-center gap-2 rounded-xl border border-slate-200 bg-white px-4 py-3 text-slate-700 shadow-sm focus-within:border-indigo-300 focus-within:ring-2 focus-within:ring-indigo-100"
						>
							<input
								type="email"
								name="email"
								placeholder="Email"
								class="w-full bg-transparent text-sm outline-none placeholder:text-slate-400"
								required
							/>
						</div>
					</label>

					<label class="block">
						<span class="sr-only">Mot de passe</span>
						<div
							class="flex items-center gap-2 rounded-xl border border-slate-200 bg-white px-4 py-3 text-slate-700 shadow-sm focus-within:border-indigo-300 focus-within:ring-2 focus-within:ring-indigo-100"
						>
							<input
								type="password"
								name="password"
								placeholder="Mot de passe"
								class="w-full bg-transparent text-sm outline-none placeholder:text-slate-400"
								required
							/>
						</div>
					</label>

					<button
						type="submit"
						class="mt-2 w-full rounded-xl bg-gradient-to-r from-[#2d7dff] via-[#7d4bff] to-[#d74bff] px-4 py-3 text-sm font-semibold text-white shadow-lg shadow-blue-500/30 transition hover:-translate-y-0.5 hover:shadow-blue-500/40 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-white"
					>
						Se connecter
					</button>
				</form>
				<p
					class="font-semibold text-[#2d7dff] hover:text-[#7d4bff] flex text-center justify-center mt-4"
				>
					Je certficie a avoir plus de 18 ans
			</p>
				<p class="mt-5 text-center text-sm text-slate-600">
					Pas encore de compte ?
					<a
						href="/register"
						class="font-semibold text-[#2d7dff] hover:text-[#7d4bff]"
					>
						Créer un compte
					</a>
				</p>
			</section>
		</div>
	</main>
</Layout>
