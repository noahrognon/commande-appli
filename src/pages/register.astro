---
import Layout from "../layouts/Layout.astro";
import { supabase } from "../lib/supabaseClient";

export const prerender = false;

let error: string | null = null;
let success: string | null = null;

if (Astro.request.method === "POST") {
	const contentType = (Astro.request.headers.get("content-type") || "").toLowerCase();

	let firstName = "";
	let lastName = "";
	let email = "";
	let phone = "";
	let password = "";
	let passwordConfirm = "";

	try {
		if (
			contentType.includes("multipart/form-data") ||
			contentType.includes("application/x-www-form-urlencoded") ||
			!contentType
		) {
			const formData = await Astro.request.formData();
			firstName = String(formData.get("firstName") || "");
			lastName = String(formData.get("lastName") || "");
			email = String(formData.get("email") || "");
			phone = String(formData.get("phone") || "");
			password = String(formData.get("password") || "");
			passwordConfirm = String(formData.get("passwordConfirm") || "");
		} else if (contentType.includes("application/json")) {
			const body = (await Astro.request.json()) as Record<string, unknown>;
			firstName = String(body.firstName || "");
			lastName = String(body.lastName || "");
			email = String(body.email || "");
			phone = String(body.phone || "");
			password = String(body.password || "");
			passwordConfirm = String(body.passwordConfirm || "");
		} else {
			throw new Error("Unsupported content-type");
		}

		if (!email || !password) {
			error = "Email et mot de passe obligatoires.";
		} else if (password !== passwordConfirm) {
			error = "Les mots de passe ne correspondent pas.";
		} else {
			const { error: signUpError } = await supabase.auth.signUp({
				email,
				password,
				options: {
					data: {
						first_name: firstName,
						last_name: lastName,
						phone
					}
				}
			});

			if (signUpError) {
				error = signUpError.message;
			} else {
				success = "Compte cree. Verifiez vos emails pour confirmer votre compte.";
			}
		}
	} catch {
		error = "Le formulaire n'a pas pu être lu. Merci de réessayer.";
	}
}
---

<Layout>
	<main class="min-h-screen bg-gradient-to-b from-white via-[#f1f4ff] to-[#f5e7ff] px-4 py-10 sm:px-6 lg:px-8">
		<div class="mx-auto flex max-w-md flex-col gap-6">
			<a href="/" class="inline-flex items-center gap-2 text-sm text-slate-600 hover:text-slate-800">
				<span class="text-lg">←</span>
				<span>Retour</span>
			</a>

			<section class="rounded-[28px] bg-white/80 p-6 shadow-xl ring-1 ring-slate-100 backdrop-blur-md sm:p-8">
				<div class="space-y-1 text-center">
					<p class="text-xl font-semibold bg-gradient-to-r from-[#3d7fff] via-[#9d55ff] to-[#d94bff] bg-clip-text text-transparent">
						Les Gens Avant L'Argent
					</p>
					<h1 class="text-2xl font-semibold text-slate-900">Créer un compte</h1>
					<p class="text-sm text-slate-600">Rejoignez Les Gens Avant L'Argent dès maintenant</p>
				</div>

				{error && (
					<p class="mt-4 rounded-xl bg-red-50 px-4 py-3 text-sm text-red-700">
						{error}
					</p>
				)}
				{success && (
					<p class="mt-4 rounded-xl bg-emerald-50 px-4 py-3 text-sm text-emerald-700">
						{success}
					</p>
				)}

				<form method="POST" class="mt-6 space-y-4">
					<div class="grid grid-cols-1 gap-3 sm:grid-cols-2">
						<label class="block">
							<span class="sr-only">Prénom</span>
							<div class="flex items-center gap-2 rounded-xl border border-slate-200 bg-white px-4 py-3 text-slate-700 shadow-sm focus-within:border-indigo-300 focus-within:ring-2 focus-within:ring-indigo-100">
								<input
									type="text"
									name="firstName"
									placeholder="Prénom"
									class="w-full bg-transparent text-sm outline-none placeholder:text-slate-400"
									required
								/>
							</div>
						</label>
						<label class="block">
							<span class="sr-only">Nom</span>
							<div class="flex items-center gap-2 rounded-xl border border-slate-200 bg-white px-4 py-3 text-slate-700 shadow-sm focus-within:border-indigo-300 focus-within:ring-2 focus-within:ring-indigo-100">
								<input
									type="text"
									name="lastName"
									placeholder="Nom"
									class="w-full bg-transparent text-sm outline-none placeholder:text-slate-400"
									required
								/>
							</div>
						</label>
					</div>

					<label class="block">
						<span class="sr-only">Email</span>
						<div class="flex items-center gap-2 rounded-xl border border-slate-200 bg-white px-4 py-3 text-slate-700 shadow-sm focus-within:border-indigo-300 focus-within:ring-2 focus-within:ring-indigo-100">
							<input
								type="email"
								name="email"
								placeholder="Email"
								class="w-full bg-transparent text-sm outline-none placeholder:text-slate-400"
								required
							/>
						</div>
					</label>

					<label class="block">
						<span class="sr-only">Téléphone</span>
						<div class="flex items-center gap-2 rounded-xl border border-slate-200 bg-white px-4 py-3 text-slate-700 shadow-sm focus-within:border-indigo-300 focus-within:ring-2 focus-within:ring-indigo-100">
							<input
								type="tel"
								name="phone"
								placeholder="Téléphone"
								class="w-full bg-transparent text-sm outline-none placeholder:text-slate-400"
							/>
						</div>
					</label>

					<label class="block">
						<span class="sr-only">Mot de passe</span>
						<div class="flex items-center gap-2 rounded-xl border border-slate-200 bg-white px-4 py-3 text-slate-700 shadow-sm focus-within:border-indigo-300 focus-within:ring-2 focus-within:ring-indigo-100">
							<input
								type="password"
								name="password"
								placeholder="Mot de passe"
								class="w-full bg-transparent text-sm outline-none placeholder:text-slate-400"
								required
							/>
						</div>
					</label>

					<label class="block">
						<span class="sr-only">Confirmer le mot de passe</span>
						<div class="flex items-center gap-2 rounded-xl border border-slate-200 bg-white px-4 py-3 text-slate-700 shadow-sm focus-within:border-indigo-300 focus-within:ring-2 focus-within:ring-indigo-100">
							<input
								type="password"
								name="passwordConfirm"
								placeholder="Confirmer le mot de passe"
								class="w-full bg-transparent text-sm outline-none placeholder:text-slate-400"
								required
							/>
						</div>
					</label>

					<button
						type="submit"
						class="mt-2 w-full rounded-xl bg-gradient-to-r from-[#2d7dff] via-[#7d4bff] to-[#d74bff] px-4 py-3 text-sm font-semibold text-white shadow-lg shadow-blue-500/30 transition hover:-translate-y-0.5 hover:shadow-blue-500/40 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-white"
					>
						Créer mon compte
					</button>
				</form>
                <p
					class="font-semibold text-[#2d7dff] hover:text-[#7d4bff] flex text-center justify-center mt-4"
				>
					Je certficie a avoir plus de 18 ans
			</p>
				<p class="mt-5 text-center text-sm text-slate-600">
					Déjà un compte ?
					<a href="/login" class="font-semibold text-[#2d7dff] hover:text-[#7d4bff]">
						Se connecter
					</a>
				</p>
			</section>
		</div>
	</main>
</Layout>
