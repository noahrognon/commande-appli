---
import Layout from "../../layouts/Layout.astro";
import crypto from "node:crypto";
import { supabaseAdmin } from "../../lib/supabaseAdmin";
import { createAdminSessionToken, getAdminFromRequest, setAdminSessionCookie } from "../../lib/adminAuth";

export const prerender = false;

let error: string | null = null;

const existingAdmin = await getAdminFromRequest(Astro.request);
if (existingAdmin) {
	return Astro.redirect("/admin");
}

if (Astro.request.method === "POST") {
	const contentType = (Astro.request.headers.get("content-type") || "").toLowerCase();
	let email = "";
	let password = "";

	try {
		if (
			contentType.includes("multipart/form-data") ||
			contentType.includes("application/x-www-form-urlencoded") ||
			!contentType
		) {
			const formData = await Astro.request.formData();
			email = String(formData.get("email") || "").trim().toLowerCase();
			password = String(formData.get("password") || "");
		} else if (contentType.includes("application/json")) {
			const body = (await Astro.request.json()) as Record<string, unknown>;
			email = String(body.email || "").trim().toLowerCase();
			password = String(body.password || "");
		} else {
			throw new Error("Unsupported content-type");
		}

		if (!email || !password) {
			error = "Email et mot de passe obligatoires.";
		} else if (!supabaseAdmin) {
			error = "Configuration admin indisponible.";
		} else {
			const { data: adminRow, error: adminError } = await supabaseAdmin
				.from("admins")
				.select("id, email, password_hash")
				.eq("email", email)
				.maybeSingle();

			if (adminError || !adminRow) {
				error = "Acces refuse.";
			} else {
				const stored = String(adminRow.password_hash || "");
				const provided = String(password);
				const storedBuffer = Buffer.from(stored);
				const providedBuffer = Buffer.from(provided);
				const match =
					storedBuffer.length === providedBuffer.length &&
					crypto.timingSafeEqual(storedBuffer, providedBuffer);

				if (!match) {
					error = "Acces refuse.";
				} else {
					const token = createAdminSessionToken({ id: adminRow.id, email: adminRow.email });
					setAdminSessionCookie(Astro, token);
					return Astro.redirect("/admin");
				}
			}
		}
	} catch {
		error = "Le formulaire n'a pas pu etre lu. Merci de reessayer.";
	}
}
---

<Layout>
	<main class="min-h-screen bg-gradient-to-b from-white via-[#f1f4ff] to-[#f5e7ff] px-4 py-12 sm:px-6 lg:px-8">
		<div class="mx-auto flex max-w-md flex-col gap-6">
			<a href="/" class="inline-flex items-center gap-2 text-sm text-slate-600 hover:text-slate-800">
				<span class="text-lg">&lt;</span>
				<span>Retour</span>
			</a>

			<section class="rounded-[28px] bg-white/85 p-6 shadow-xl ring-1 ring-slate-100 backdrop-blur-md sm:p-8">
				<div class="space-y-1 text-center">
					<p class="text-sm font-semibold uppercase tracking-widest text-slate-500">Acces admin</p>
					<h1 class="text-2xl font-semibold text-slate-900">Connexion admin</h1>
					<p class="text-sm text-slate-600">Espace reserve a l'equipe.</p>
				</div>

				{error && (
					<p class="mt-4 rounded-xl bg-red-50 px-4 py-3 text-sm text-red-700">
						{error}
					</p>
				)}

				<form method="POST" class="mt-6 space-y-4">
					<label class="block">
						<span class="sr-only">Email</span>
						<div class="flex items-center gap-2 rounded-xl border border-slate-200 bg-white px-4 py-3 text-slate-700 shadow-sm focus-within:border-indigo-300 focus-within:ring-2 focus-within:ring-indigo-100">
							<input
								type="email"
								name="email"
								placeholder="Email admin"
								class="w-full bg-transparent text-sm outline-none placeholder:text-slate-400"
								required
							/>
						</div>
					</label>

					<label class="block">
						<span class="sr-only">Mot de passe</span>
						<div class="flex items-center gap-2 rounded-xl border border-slate-200 bg-white px-4 py-3 text-slate-700 shadow-sm focus-within:border-indigo-300 focus-within:ring-2 focus-within:ring-indigo-100">
							<input
								type="password"
								name="password"
								placeholder="Mot de passe"
								class="w-full bg-transparent text-sm outline-none placeholder:text-slate-400"
								required
							/>
						</div>
					</label>

					<button
						type="submit"
						class="mt-2 w-full rounded-xl bg-gradient-to-r from-[#2d7dff] via-[#7d4bff] to-[#d74bff] px-4 py-3 text-sm font-semibold text-white shadow-lg shadow-blue-500/30 transition hover:-translate-y-0.5 hover:shadow-blue-500/40 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-white"
					>
						Se connecter
					</button>
				</form>
			</section>
		</div>
	</main>
</Layout>

